var MapViz={bug:null,mapPath:"data/us4.json",dataPath:"data/nmaj-nshg.json",us:null,data:null,mapSelector:"#mapViz",sliderSelector:"#mapSlider",YlOrBr:["#ffffe5","#fff7bc","#fee391","#fec44f","#fe9929","#ec7014","#cc4c02","#993404","#662506"],projection:null,path:null,disease:"Chlamydia trachomatis infection",year:"2016",week:1,method:"cum_2015",init:function(){d3.select(window).on("resize",MapViz.sizeChange),MapViz.setMap()},setMap:function(){d3.json(MapViz.mapPath,function(e,a){return e?console.error(e):void d3.json(MapViz.dataPath,function(e,t){return e?console.error(e):(MapViz.us=a,MapViz.data=t,MapViz.processData(),void MapViz.drawMap())})})},drawMap:function(){this.projection=d3.geo.albersUsa().scale(1100),this.path=d3.geo.path().projection(this.projection);var e=d3.select(this.mapSelector).append("svg").attr("width","100%").append("g");MapViz.sizeChange(),e.selectAll(".state").data(this.us.features).enter().append("path").attr("class","state").attr("d",this.path),MapViz.colorMap(this.disease,this.year,this.week,this.method),console.log(this.us),MapViz.drawSlider()},drawSlider:function(){d3.select(MapViz.sliderSelector).remove(),d3.select("#sliderContainer").append("div").attr("id",MapViz.sliderSelector.replace("#",""));var e=MapViz.getWeekRange(MapViz.disease,MapViz.year);console.log("week range: "+e),d3.select(MapViz.sliderSelector).call(d3.slider().axis(!0).min(e[0]).max(e[1]).step(1).on("slide",function(e,a){MapViz.sequenceMap("Chlamydia trachomatis infection","2016",a,"cum_2015")}))},colorMap:function(e,a,t,r){var i=MapViz.getDataRange(e,a,t,r);d3.selectAll(".state").style("fill",function(o){var n=MapViz.getValueFromNest(o.properties,e,a,t,r);MapViz.setCurrentData(o.properties,n,e,a,t,r);var s=MapViz.getColor(n,i);return s})},sequenceMap:function(e,a,t,r){var i=MapViz.getDataRange(e,a,t,r);d3.selectAll(".state").transition().duration(7).style("fill",function(o){var n=MapViz.getValueFromNest(o.properties,e,a,t,r);MapViz.setCurrentData(o.properties,n,e,a,t,r);var s=MapViz.getColor(n,i);return s})},getColor:function(e,a){if(-1==e|void 0==e)return"#CCC7C8";var t=d3.scale.quantize().domain([a[0],a[1]]).range(MapViz.YlOrBr);return t(e)},getDataRange:function(e,a,t,r){var i=1/0,o=-(1/0),n=1;return d3.selectAll(".state").each(function(n,s){var p=Number(MapViz.getValueFromNest(n.properties,e,a,t,r));i>=p&&-1!=p&&"undefined"!=p&&(i=p),p>=o&&-1!=p&&"undefined"!=p&&(o=p)}),[i,o]},getWeekRange:function(e,a){var t=1,r=2;return d3.selectAll(".state").each(function(t,i){var o=MapViz.getMaxWeekFromNest(t.properties,e,a);o>r&&(r=o)}),[t,r]},sizeChange:function(){console.log("Resizing"),console.log("Selector: "+MapViz.mapSelector),d3.select("#mapViz g").attr("transform","scale("+$("#mapViz").width()/900+")"),$("svg").height(.618*$("#mapViz").width()),MapViz.drawSlider()},processData:function(){var e=_.groupBy(MapViz.data,"reporting_area");console.log(MapViz.us);for(var a in MapViz.us.features)for(var t in e)featureName=MapViz.us.features[a].properties.NAME,featureName.toLowerCase()==t.toLowerCase()?MapViz.assignDataToFeatureProperty(MapViz.us.features[a].properties,e[t]):"District of Columbia"==featureName&&"DIST. OF COL."==t&&MapViz.assignDataToFeatureProperty(MapViz.us.features[a].properties,e[t])},assignDataToFeatureProperty:function(e,a){var t=_.groupBy(a,"disease"),r={};_.each(t,function(e,a){r[a]=_.groupBy(e,"mmwr_year")});var i={};_.each(r,function(e,a){i[a]="",_.each(e,function(e,t){var r={};r[t]=_.groupBy(e,"mmwr_week"),i[a]=r})}),e.nested_data=i,e.rawdata=a},setCurrentData:function(e,a,t,r,i,o){var n={};n.value=a,n.disease=t,n.year=r,n.week=i,e.currentData=n},getCurrentValue:function(e){return e.currentData.value},getValueFromNest:function(e,a,t,r,i){var o=-1;try{e.nested_data[a][t][r].length>1&&console.log("Warning: There is more than one row for this input combination ->disease: "+a+", year: "+t+", week: "+r),o=e.nested_data[a][t][r][0][i]}catch(n){console.log("DEBUG: The Value doesn't exist for this input combination -> disease: "+a+", year: "+t+", week: "+r+", method: "+i)}if(void 0==o){var o=-1;console.log("DEBUG: The Value doesn't exist for this input combination -> disease: "+a+", year: "+t+", week: "+r+", method: "+i)}return o},getMaxWeekFromNest:function(e,a,t){try{var t=e.nested_data[a][t],r=_.keys(t),i=Number(r.pop());return console.log(i),i}catch(o){return console.log("DEBUG: Weeks don't exist for this input combination -> disease: "+a+", year: "+t+". Error: "+o),1}}};window.onload=MapViz.init();