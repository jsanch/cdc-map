var MapViz={bug:null,mapPath:"data/us4.json",dataPath:"data/nmaj-nshg.json",us:null,data:null,mapSelector:"#mapViz",sliderSelector:"#mapSlider",YlOrBr:["#ffffe5","#fff7bc","#fee391","#fec44f","#fe9929","#ec7014","#cc4c02","#993404","#662506"],projection:null,path:null,diseases:null,years:null,methods:["previous_52_weeks_max","previous_52_weeks_med","cum_2015","cum_2016"],disease:"Chlamydia trachomatis infection",year:"2016",week:1,method:"cum_2015",mapLoaded:!1,init:function(){d3.select(window).on("resize",MapViz.sizeChange),MapViz.setMap()},setMap:function(){d3.json(MapViz.mapPath,function(e,a){return e?console.error(e):void d3.json(MapViz.dataPath,function(e,t){return e?console.error(e):(MapViz.us=a,MapViz.data=t,MapViz.processData(),MapViz.populateDropDowns(),void MapViz.drawMap())})})},populateDropDowns:function(){var e=["diseases","years","methods"];_.each(e,function(e){var a=e.slice(0,-1);MapViz[a]=Array.from(MapViz[e])[0]}),_.each(e,function(e){d3.select("#"+e).selectAll("option").data(Array.from(MapViz[e])).enter().append("option").html(function(e){return e}).attr("value",function(e){return e}),$(".selectpicker").selectpicker("refresh"),$("#"+e).on("changed.bs.select",function(a,t){var r=e.slice(0,-1);MapViz[r]=Array.from(MapViz[e])[t],MapViz.drawSlider(),MapViz.sequenceMap(MapViz.disease,MapViz.year,MapViz.week,MapViz.method)})}),console.log(MapViz.years),console.log(MapViz.diseases)},drawMap:function(){this.projection=d3.geo.albersUsa().scale(1100),this.path=d3.geo.path().projection(this.projection);var e=d3.select(this.mapSelector).append("svg").attr("width","100%").append("g");e.selectAll(".state").data(this.us.features).enter().append("path").attr("class","state").attr("d",this.path),console.log("Coloring Map..."),console.log(MapViz.us),MapViz.colorMap(this.disease,this.year,this.week,this.method),MapViz.drawSlider(),MapViz.sizeChange()},drawSlider:function(){MapViz.mapLoaded&&d3.select(".slider-description").classed("hide",!1),d3.select(MapViz.sliderSelector).remove(),d3.select("#sliderContainer").append("div").attr("id",MapViz.sliderSelector.replace("#",""));var e=MapViz.getWeekRange(MapViz.disease,MapViz.year);d3.select(MapViz.sliderSelector).call(d3.slider().axis(!0).min(e[0]).max(e[1]).step(1).on("slide",function(e,a){MapViz.sequenceMap("Chlamydia trachomatis infection","2016",a,"cum_2015")}))},colorMap:function(e,a,t,r){var i=MapViz.getDataRange(e,a,t,r);d3.selectAll(".state").style("fill",function(o){var s=MapViz.getValueFromNest(o.properties,e,a,t,r);MapViz.setCurrentData(o.properties,s,e,a,t,r);var n=MapViz.getColor(s,i);return n}),MapViz.mapLoaded=!0},sequenceMap:function(e,a,t,r){var i=MapViz.getDataRange(e,a,t,r);d3.selectAll(".state").transition().duration(7).style("fill",function(o){var s=MapViz.getValueFromNest(o.properties,e,a,t,r);MapViz.setCurrentData(o.properties,s,e,a,t,r);var n=MapViz.getColor(s,i);return n})},getColor:function(e,a){if(-1==e|void 0==e)return"#CCC7C8";var t=d3.scale.quantize().domain([a[0],a[1]]).range(MapViz.YlOrBr);return t(e)},getDataRange:function(e,a,t,r){var i=1/0,o=-(1/0),s=1;return d3.selectAll(".state").each(function(s,n){var p=Number(MapViz.getValueFromNest(s.properties,e,a,t,r));i>=p&&-1!=p&&"undefined"!=p&&(i=p),p>=o&&-1!=p&&"undefined"!=p&&(o=p)}),[i,o]},getWeekRange:function(e,a){var t=1,r=2;return d3.selectAll(".state").each(function(t,i){var o=MapViz.getMaxWeekFromNest(t.properties,e,a);o>r&&(r=o)}),[t,r]},sizeChange:function(){d3.select("#mapViz g").attr("transform","scale("+$("#mapViz").width()/900+")"),$("svg").height(.618*$("#mapViz").width()),MapViz.mapLoaded&&MapViz.drawSlider()},processData:function(){MapViz.diseases=new Set,MapViz.years=new Set;var e=_.groupBy(MapViz.data,"reporting_area");for(var a in MapViz.us.features)for(var t in e)featureName=MapViz.us.features[a].properties.NAME,featureName.toLowerCase()==t.toLowerCase()?MapViz.assignDataToFeatureProperty(MapViz.us.features[a].properties,e[t]):"District of Columbia"==featureName&&"DIST. OF COL."==t&&MapViz.assignDataToFeatureProperty(MapViz.us.features[a].properties,e[t])},assignDataToFeatureProperty:function(e,a){var t=_.groupBy(a,"disease");_.each(_.keys(t),function(e){MapViz.diseases.add(e)});var r={};_.each(t,function(e,a){r[a]=_.groupBy(e,"mmwr_year"),_.each(_.keys(r[a]),function(e){MapViz.years.add(e)})});var i={};_.each(r,function(e,a){i[a]="",_.each(e,function(e,t){var r={};r[t]=_.groupBy(e,"mmwr_week"),i[a]=r})}),e.nested_data=i,e.rawdata=a},setCurrentData:function(e,a,t,r,i,o){var s={};s.value=a,s.disease=t,s.year=r,s.week=i,e.currentData=s},getCurrentValue:function(e){return e.currentData.value},getValueFromNest:function(e,a,t,r,i){var o=-1;try{e.nested_data[a][t][r].length>1&&console.log("Warning: There is more than one row for this input combination ->disease: "+a+", year: "+t+", week: "+r),o=e.nested_data[a][t][r][0][i]}catch(s){console.log("DEBUG: The Value doesn't exist for this input combination -> disease: "+a+", year: "+t+", week: "+r+", method: "+i+" Area: "+e.NAME)}if(void 0==o){var o=-1;console.log("DEBUG: The Value doesn't exist for this input combination -> disease: "+a+", year: "+t+", week: "+r+", method: "+i+" Area: "+e.NAME)}return o},getMaxWeekFromNest:function(e,a,t){try{var t=e.nested_data[a][t],r=_.keys(t),i=Number(r.pop());return i}catch(o){return console.log("DEBUG: Weeks don't exist for this input combination -> disease: "+a+", year: "+t+". Error: "+o),1}}};window.onload=MapViz.init();